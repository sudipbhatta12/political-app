<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Political Social Media Assessment - Nepal Elections</title>
    <meta name="description"
        content="Track and analyze social media sentiment of political candidates in Nepal's elections">

    <!-- Fonts - Premium Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Devanagari:wght@400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Lucide Icons - Premium SVG Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="index.css">

    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>

    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>

    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>

<body>
    <!-- Background Animation Canvas -->
    <canvas id="bg-canvas"></canvas>

    <!-- Header -->
    <header class="header">
        <div class="header__brand" id="homeBtn">
            <div class="logo-box">
                <i data-lucide="bar-chart-3"></i>
            </div>
            <div class="brand-text">
                <h1 class="header__title">Political Assessment</h1>
                <p class="header__subtitle">Nepal Elections</p>
            </div>
        </div>

        <nav class="header__nav">
            <button class="nav-item" id="libraryBtn">
                <i data-lucide="library"></i>
                <span>Library</span>
            </button>
            <button class="nav-item" id="dailyReportsBtn">
                <i data-lucide="bar-chart-2"></i>
                <span>Daily Reports</span>
            </button>
        </nav>

        <div class="header__actions">
            <!-- AI Analysis -->
            <button class="btn btn--glass btn--glow" id="aiBtn">
                <i data-lucide="sparkles" style="color: #a78bfa;"></i>
                <span>AI Analysis</span>
            </button>

            <!-- Add Source Dropdown -->
            <div class="dropdown" id="addSourceDropdown" style="display: none !important;">
                <button class="btn btn--primary" id="addSourceBtn">
                    <i data-lucide="plus" class="btn__icon"></i>
                    <span>Add Source</span>
                    <i data-lucide="chevron-down"
                        style="width: 14px; height: 14px; margin-left: 4px; opacity: 0.7;"></i>
                </button>
                <div class="dropdown-menu" id="addSourceMenu">
                    <button class="dropdown-item" id="addNewsArticleBtn">
                        <i data-lucide="newspaper" style="color: #F59E0B;"></i>
                        News Article
                    </button>
                    <button class="dropdown-item" id="addPartyPostBtn">
                        <i data-lucide="landmark" style="color: #8B5CF6;"></i>
                        Political Party
                    </button>
                    <button class="dropdown-item" id="addCandidateBtn">
                        <i data-lucide="user" style="color: #10B981;"></i>
                        Candidate Post
                    </button>
                </div>
            </div>

            <div class="divider-vertical"></div>

            <button class="btn-icon-ghost" id="logoutBtn" title="Logout">
                <i data-lucide="log-out"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container">
        <!-- Filters Section -->
        <section class="filters">
            <div class="filters__dropdowns">
                <div class="form-group">
                    <label class="form-group__label">Province</label>
                    <select class="form-group__select" id="provinceSelect">
                        <option value="">Select Province</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-group__label">District</label>
                    <select class="form-group__select" id="districtSelect" disabled>
                        <option value="">Select District</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-group__label">Election Constituency</label>
                    <select class="form-group__select" id="constituencySelect" disabled>
                        <option value="">Select Constituency</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Timeline Navigation -->
        <section class="timeline" id="timelineSection" style="display: none; margin-bottom: 24px;">
            <div class="timeline-bar"
                style="display: flex; align-items: center; justify-content: center; gap: 16px; background: rgba(255,255,255,0.05); padding: 12px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1);">
                <button class="btn btn--icon btn--secondary" id="prevDateBtn" title="Previous Date">
                    <i data-lucide="chevron-left"></i>
                </button>
                <div class="timeline-date" style="text-align: center;">
                    <span id="currentDateDisplay"
                        style="font-size: 1.1rem; font-weight: 600; color: white; display: block;">Today</span>
                    <span id="dateStatus" style="font-size: 0.8rem; color: #a0a0b0;">Latest Data</span>
                </div>
                <button class="btn btn--icon btn--secondary" id="nextDateBtn" title="Next Date">
                    <i data-lucide="chevron-right"></i>
                </button>
            </div>
        </section>

        <!-- Party Cards Grid -->
        <section class="party-grid" id="partyGrid">
            <!-- Cards will be dynamically inserted here -->
            <div class="empty-state" id="emptyState">
                <i data-lucide="bar-chart-big"
                    style="width: 64px; height: 64px; opacity: 0.5; color: var(--accent-primary);"></i>
                <h3 class="empty-state__title">No Candidates to Display</h3>
                <p class="empty-state__subtitle">Select a constituency or search to view analysis</p>

                <!-- Recently Updated -->
                <div id="recentConstituencies" class="recent-updates" style="display: none;">
                    <p class="recent-updates__title">RECENTLY UPDATED</p>
                    <div class="recent-tags" id="recentTags"></div>
                </div>
            </div>
        </section>

        <!-- Combined Sentiment Analysis -->
        <section class="summary-section" id="summarySection" style="display: none;">
            <h2 class="summary-section__title">
                <i data-lucide="bar-chart-2" style="width: 20px; height: 20px;"></i>
                Combined Sentiment Analysis
            </h2>
            <div class="summary-section__chart" id="summaryChart"></div>
        </section>

        <!-- Winner Section -->
        <section class="winner-section" id="winnerSection" style="display: none;">
            <div class="winner-content">
                <div class="winner-info">
                    <div class="winner-card">
                        <h3 class="winner-card__name" id="winnerName">-</h3>
                        <p class="winner-card__party" id="winnerParty">-</p>
                        <div class="winner-stats">
                            <div class="winner-stat winner-stat--positive">
                                <span class="winner-stat__value" id="winnerPositive">0%</span>
                                <span class="winner-stat__label">Positive</span>
                            </div>
                            <div class="winner-stat winner-stat--negative">
                                <span class="winner-stat__value" id="winnerNegative">0%</span>
                                <span class="winner-stat__label">Negative</span>
                            </div>
                            <div class="winner-stat winner-stat--neutral">
                                <span class="winner-stat__value" id="winnerNeutral">0%</span>
                                <span class="winner-stat__label">Neutral</span>
                            </div>
                        </div>
                    </div>
                    <div class="winner-chart" id="winnerChart"></div>
                </div>
                <div class="winner-remarks">
                    <h4 class="winner-remarks__title">
                        <i data-lucide="message-square" style="width: 16px; height: 16px;"></i>
                        Detailed Analysis
                    </h4>
                    <div class="winner-remarks__grid">
                        <div class="winner-remark winner-remark--positive">
                            <h5>Positive Remarks</h5>
                            <p id="winnerPositiveRemarks">No remarks available</p>
                        </div>
                        <div class="winner-remark winner-remark--negative">
                            <h5>Negative Remarks</h5>
                            <p id="winnerNegativeRemarks">No remarks available</p>
                        </div>
                        <div class="winner-remark winner-remark--neutral">
                            <h5>Neutral Remarks</h5>
                            <p id="winnerNeutralRemarks">No remarks available</p>
                        </div>
                        <div class="winner-remark winner-remark--conclusion">
                            <h5>Conclusion</h5>
                            <p id="winnerConclusion">No conclusion available</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Add/Edit Candidate Modal -->
    <div class="modal-overlay" id="candidateModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title" id="modalTitle">Add Candidate</h3>
                <button class="modal__close" id="modalClose">&times;</button>
            </div>
            <div class="modal__body">
                <form id="candidateForm" class="form-grid">
                    <input type="hidden" id="candidateId">
                    <input type="hidden" id="postId">

                    <!-- Location Selection -->
                    <div class="form-row">
                        <label for="modalProvince">Province *</label>
                        <select id="modalProvince" required>
                            <option value="">Select Province</option>
                        </select>
                    </div>

                    <div class="form-grid form-grid--2col">
                        <div class="form-row">
                            <label for="modalDistrict">District *</label>
                            <select id="modalDistrict" required disabled>
                                <option value="">Select District</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="modalConstituency">Constituency *</label>
                            <select id="modalConstituency" required disabled>
                                <option value="">Select Constituency</option>
                            </select>
                        </div>
                    </div>

                    <hr style="border-color: var(--border-glass);">

                    <!-- Candidate Selector -->
                    <div class="form-row">
                        <label for="candidateSelect">Select Candidate *</label>
                        <select id="candidateSelect" required disabled>
                            <option value="">-- Select a Candidate --</option>
                        </select>
                        <small class="text-muted mt-1">Choose from imported candidates</small>
                    </div>

                    <!-- Candidate Info (Editable after auto-fill) -->
                    <div class="form-grid form-grid--2col">
                        <div class="form-row">
                            <label for="candidateName">Candidate Name</label>
                            <input type="text" id="candidateName" placeholder="Auto-filled from selection">
                        </div>
                        <div class="form-row">
                            <label for="partyName">Party Name</label>
                            <input type="text" id="partyName" placeholder="Auto-filled from selection">
                        </div>
                    </div>

                    <hr style="border-color: var(--border-glass);">

                    <!-- Post Info -->
                    <div class="form-row">
                        <label for="postUrl">Post URL</label>
                        <input type="url" id="postUrl" placeholder="https://facebook.com/...">
                    </div>

                    <div class="form-row">
                        <label for="publishedDate">Published Date</label>
                        <input type="date" id="publishedDate">
                    </div>

                    <!-- Sentiment Percentages -->
                    <div class="form-row">
                        <label>Sentiment Analysis (%)</label>
                        <div class="sentiment-inputs">
                            <div class="sentiment-input sentiment-input--positive">
                                <label for="positivePercent">Positive</label>
                                <input type="number" id="positivePercent" min="0" max="100" step="0.01" value="0">
                            </div>
                            <div class="sentiment-input sentiment-input--negative">
                                <label for="negativePercent">Negative</label>
                                <input type="number" id="negativePercent" min="0" max="100" step="0.01" value="0">
                            </div>
                            <div class="sentiment-input sentiment-input--neutral">
                                <label for="neutralPercent">Neutral</label>
                                <input type="number" id="neutralPercent" min="0" max="100" step="0.01" value="0">
                            </div>
                        </div>
                        <small class="text-muted mt-1">Total should equal 100%</small>
                    </div>

                    <!-- Remarks Section -->
                    <div class="form-row">
                        <label for="positiveRemarks">Positive Remarks</label>
                        <textarea id="positiveRemarks" rows="2"
                            placeholder="What is positive about this candidate?"></textarea>
                    </div>

                    <div class="form-row">
                        <label for="negativeRemarks">Negative Remarks</label>
                        <textarea id="negativeRemarks" rows="2"
                            placeholder="What is negative about this candidate?"></textarea>
                    </div>

                    <div class="form-row">
                        <label for="neutralRemarks">Neutral Remarks</label>
                        <textarea id="neutralRemarks" rows="2"
                            placeholder="What is neutral about this candidate?"></textarea>
                    </div>

                    <div class="form-row">
                        <label for="conclusion">Conclusion</label>
                        <textarea id="conclusion" rows="3"
                            placeholder="Overall conclusion about this candidate..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" id="modalCancel">Cancel</button>
                <button type="submit" form="candidateForm" class="btn btn--primary">Save Post Data</button>
            </div>
        </div>
    </div>

    <!-- Comments Modal -->
    <div class="modal-overlay comments-modal" id="commentsModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title" id="commentsTitle">Comments</h3>
                <button class="modal__close" id="commentsModalClose">&times;</button>
            </div>
            <div class="modal__body">
                <div class="comments-list" id="commentsList">
                    <!-- Comments will be inserted here -->
                </div>
                <div class="add-comment-form">
                    <input type="text" id="newCommentInput" placeholder="Add a comment...">
                    <select id="commentSentiment">
                        <option value="positive">Positive</option>
                        <option value="negative">Negative</option>
                        <option value="neutral">Neutral</option>
                    </select>
                    <button class="btn btn--primary btn--small" id="addCommentBtn">Add</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Remarks Modal (for viewing remarks when clicking percentage buttons) -->
    <div class="modal-overlay remarks-modal" id="remarksModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title" id="remarksTitle">Remarks</h3>
                <button class="modal__close" id="remarksModalClose">&times;</button>
            </div>
            <div class="modal__body">
                <div id="remarksContent" class="remarks-content">
                    <!-- Remarks content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Library Modal (Tabbed for all sources) -->
    <div class="modal-overlay library-modal" id="libraryModal">
        <div class="modal modal--large" style="max-width: 1200px;">
            <div class="modal__header">
                <h3 class="modal__title">
                    <i data-lucide="library" style="width: 20px; height: 20px;"></i>
                    Source Library
                </h3>
                <button class="modal__close" id="libraryModalClose">&times;</button>
            </div>
            <div class="modal__body">
                <!-- Library Tabs -->
            </div>

            <!-- Library Tabs with Filter -->
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1);">
                <div style="display: flex; gap: 0;">
                    <button class="library-tab active" data-tab="candidates"
                        style="padding: 12px 24px; background: transparent; border: none; color: #10B981; border-bottom: 2px solid #10B981; cursor: pointer; font-weight: 500;">
                        <i data-lucide="user" style="width: 14px; height: 14px;"></i>
                        Candidates
                    </button>
                    <button class="library-tab" data-tab="news"
                        style="padding: 12px 24px; background: transparent; border: none; color: #999; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500;">
                        <i data-lucide="newspaper" style="width: 14px; height: 14px;"></i>
                        News Media
                    </button>
                    <button class="library-tab" data-tab="parties"
                        style="padding: 12px 24px; background: transparent; border: none; color: #999; border-bottom: 2px solid transparent; cursor: pointer; font-weight: 500;">
                        <i data-lucide="landmark" style="width: 14px; height: 14px;"></i>
                        Political Parties
                    </button>
                </div>

                <!-- Global Date Filter -->
                <div class="library-filter-group"
                    style="display: flex; align-items: center; gap: 8px; padding-right: 10px;">
                    <input type="date" id="libraryDateFilter" class="library-date-filter" title="Filter by date"
                        style="background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 6px 10px; border-radius: 6px; font-family: 'Inter', sans-serif;">
                    <button id="clearLibraryFilter" class="btn btn--icon btn--secondary btn--small" title="Clear filter"
                        style="display: none; background: rgba(255,255,255,0.1); border: none; color: rgba(255,255,255,0.7);">
                        <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                    </button>
                </div>
            </div>

            <!-- Candidates Tab Content -->
            <div id="tabCandidates" class="tab-content">
                <div class="library-actions">
                    <div class="library-actions__left">
                        <span class="library-count" id="libraryCount">0 records</span>
                        <div class="library-filter-group">
                            <!-- Filter moved to global header -->
                        </div>
                        <button class="btn btn--small btn--primary" id="addCandidateLibraryBtn"
                            style="background: linear-gradient(135deg, #10B981, #059669); display: none !important;">
                            <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                            Add Candidate Post
                        </button>
                    </div>
                    <div class="library-actions__right">
                        <button class="btn btn--small btn--secondary" id="exportAllExcel">
                            <i data-lucide="file-spreadsheet" style="width: 14px; height: 14px;"></i>
                            Export Excel
                        </button>
                        <button class="btn btn--small btn--secondary" id="exportAllPdf">
                            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                            Export PDF
                        </button>
                    </div>
                </div>
                <div class="library-table-container">
                    <table class="library-table" id="libraryTable">
                        <thead>
                            <tr>
                                <th>Candidate</th>
                                <th>Party</th>
                                <th>Constituency</th>
                                <th>Positive</th>
                                <th>Negative</th>
                                <th>Neutral</th>
                                <th>Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="libraryTableBody"></tbody>
                    </table>
                </div>
                <div class="library-empty" id="libraryEmpty" style="display: none;">
                    <i data-lucide="inbox" style="width: 48px; height: 48px; opacity: 0.4;"></i>
                    <p>No candidate assessments yet</p>
                </div>
            </div>

            <!-- News Media Tab Content -->
            <div id="tabNews" class="tab-content" style="display: none;">
                <div class="library-actions">
                    <div class="library-actions__left">
                        <span class="library-count" id="newsCount">0 records</span>
                    </div>
                    <div class="library-actions__right">
                        <button class="btn btn--small btn--primary" id="addNewsMediaBtn"
                            style="background: linear-gradient(135deg, #F59E0B, #D97706); display: none !important;">
                            <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                            Add News Source
                        </button>
                        <button class="btn btn--small btn--secondary" id="exportNewsExcel"
                            style="display: inline-flex !important; opacity: 1 !important; visibility: visible !important;">
                            <i data-lucide="file-spreadsheet" style="width: 14px; height: 14px;"></i>
                            Export Excel
                        </button>
                        <button class="btn btn--small btn--secondary" id="exportNewsPdf"
                            style="display: inline-flex !important; opacity: 1 !important; visibility: visible !important;">
                            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                            Export PDF
                        </button>
                    </div>
                </div>
                <div class="library-table-container">
                    <table class="library-table" id="newsTable">
                        <thead>
                            <tr>
                                <th>Source Name</th>
                                <th>Posts</th>
                                <th>Positive</th>
                                <th>Negative</th>
                                <th>Neutral</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="newsTableBody"></tbody>
                    </table>
                </div>
                <div class="library-empty" id="newsEmpty" style="display: none;">
                    <i data-lucide="newspaper" style="width: 48px; height: 48px; opacity: 0.4;"></i>
                    <p>No news sources yet</p>
                    <p class="text-muted">Click "Add News Source" to add one</p>
                </div>
            </div>

            <!-- Political Parties Tab Content -->
            <div id="tabParties" class="tab-content" style="display: none;">
                <div class="library-actions">
                    <div class="library-actions__left">
                        <span class="library-count" id="partiesCount">0 records</span>
                    </div>
                    <div class="library-actions__right">
                        <button class="btn btn--small btn--primary" id="addPartyBtn"
                            style="background: linear-gradient(135deg, #8B5CF6, #7C3AED); display: none !important;">
                            <i data-lucide="plus" style="width: 14px; height: 14px;"></i>
                            Add Party
                        </button>
                        <button class="btn btn--small btn--secondary" id="exportPartiesExcel"
                            style="display: inline-flex !important; opacity: 1 !important; visibility: visible !important;">
                            <i data-lucide="file-spreadsheet" style="width: 14px; height: 14px;"></i>
                            Export Excel
                        </button>
                        <button class="btn btn--small btn--secondary" id="exportPartiesPdf"
                            style="display: inline-flex !important; opacity: 1 !important; visibility: visible !important;">
                            <i data-lucide="file-text" style="width: 14px; height: 14px;"></i>
                            Export PDF
                        </button>
                    </div>
                </div>
                <div class="library-table-container">
                    <table class="library-table" id="partiesTable">
                        <thead>
                            <tr>
                                <th>Party Name</th>
                                <th>Abbreviation</th>
                                <th>Posts</th>
                                <th>Positive</th>
                                <th>Negative</th>
                                <th>Neutral</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="partiesTableBody"></tbody>
                    </table>
                </div>
                <div class="library-empty" id="partiesEmpty" style="display: none;">
                    <i data-lucide="landmark" style="width: 48px; height: 48px; opacity: 0.4;"></i>
                    <p>No political parties yet</p>
                    <p class="text-muted">Click "Add Party" to add one</p>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- News Article Modal -->
    <div class="modal-overlay" id="newsArticleModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title">
                    <i data-lucide="newspaper" style="width: 20px; height: 20px; color: #F59E0B;"></i>
                    Add News Article Analysis
                </h3>
                <button class="modal__close" id="newsArticleModalClose">&times;</button>
            </div>
            <div class="modal__body">
                <form id="newsArticleForm" class="form-grid">
                    <div class="form-row">
                        <label for="newsSourceSelect">News Source *</label>
                        <select id="newsSourceSelect" required>
                            <option value="">-- Select or Add New --</option>
                            <option value="new">+ Add New News Source</option>
                        </select>
                    </div>
                    <div class="form-row" id="newNewsSourceRow" style="display: none;">
                        <label for="newNewsSourceName">New Source Name *</label>
                        <input type="text" id="newNewsSourceName" placeholder="e.g., Kantipur Daily">
                    </div>
                    <hr style="border-color: var(--border-glass);">
                    <div class="form-row">
                        <label for="newsArticleUrl">Article URL</label>
                        <input type="url" id="newsArticleUrl" placeholder="https://...">
                    </div>
                    <div class="form-row">
                        <label for="newsArticleDate">Published Date</label>
                        <input type="date" id="newsArticleDate">
                    </div>
                    <div class="form-row">
                        <label>Sentiment Analysis (%)</label>
                        <div class="sentiment-inputs">
                            <div class="sentiment-input sentiment-input--positive">
                                <label for="newsPositive">Positive</label>
                                <input type="number" id="newsPositive" min="0" max="100" step="0.01" value="0">
                            </div>
                            <div class="sentiment-input sentiment-input--negative">
                                <label for="newsNegative">Negative</label>
                                <input type="number" id="newsNegative" min="0" max="100" step="0.01" value="0">
                            </div>
                            <div class="sentiment-input sentiment-input--neutral">
                                <label for="newsNeutral">Neutral</label>
                                <input type="number" id="newsNeutral" min="0" max="100" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="newsRemarks">Summary/Remarks</label>
                        <textarea id="newsRemarks" rows="3" placeholder="Key points from this article..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" id="newsArticleModalCancel">Cancel</button>
                <button type="submit" form="newsArticleForm" class="btn btn--primary"
                    style="background: linear-gradient(135deg, #F59E0B, #D97706);">Save Article</button>
            </div>
        </div>
    </div>

    <!-- Party Post Modal -->
    <div class="modal-overlay" id="partyPostModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title">
                    <i data-lucide="landmark" style="width: 20px; height: 20px; color: #8B5CF6;"></i>
                    Add Political Party Analysis
                </h3>
                <button class="modal__close" id="partyPostModalClose">&times;</button>
            </div>
            <div class="modal__body">
                <form id="partyPostForm" class="form-grid">
                    <div class="form-row">
                        <label for="partySelect">Political Party *</label>
                        <select id="partySelect" required>
                            <option value="">-- Select or Add New --</option>
                            <option value="new">+ Add New Party</option>
                        </select>
                    </div>
                    <div class="form-row" id="newPartyRow" style="display: none;">
                        <label for="newPartyName">Party Name *</label>
                        <input type="text" id="newPartyName" placeholder="e.g., Nepali Congress">
                    </div>
                    <div class="form-row" id="partyAbbrevRow" style="display: none;">
                        <label for="newPartyAbbrev">Abbreviation</label>
                        <input type="text" id="newPartyAbbrev" placeholder="e.g., NC">
                    </div>
                    <hr style="border-color: var(--border-glass);">
                    <div class="form-row">
                        <label for="partyPostUrl">Post URL</label>
                        <input type="url" id="partyPostUrl" placeholder="https://facebook.com/...">
                    </div>
                    <div class="form-row">
                        <label for="partyPostDate">Published Date</label>
                        <input type="date" id="partyPostDate">
                    </div>
                    <div class="form-row">
                        <label>Sentiment Analysis (%)</label>
                        <div class="sentiment-inputs">
                            <div class="sentiment-input sentiment-input--positive">
                                <label for="partyPositive">Positive</label>
                                <input type="number" id="partyPositive" min="0" max="100" step="0.01" value="0">
                            </div>
                            <div class="sentiment-input sentiment-input--negative">
                                <label for="partyNegative">Negative</label>
                                <input type="number" id="partyNegative" min="0" max="100" step="0.01" value="0">
                            </div>
                            <div class="sentiment-input sentiment-input--neutral">
                                <label for="partyNeutral">Neutral</label>
                                <input type="number" id="partyNeutral" min="0" max="100" step="0.01" value="0">
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <label for="partyRemarks">Summary/Remarks</label>
                        <textarea id="partyRemarks" rows="3" placeholder="Analysis of this post..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" id="partyPostModalCancel">Cancel</button>
                <button type="submit" form="partyPostForm" class="btn btn--primary"
                    style="background: linear-gradient(135deg, #8B5CF6, #7C3AED);">Save Analysis</button>
            </div>
        </div>
    </div>

    <!-- AI Analysis Modal -->
    <div class="modal-overlay" id="aiModal">
        <div class="modal">
            <div class="modal__header">
                <h3 class="modal__title">
                    <i data-lucide="sparkles" style="color: #8b5cf6;"></i>
                    AI Sentiment Analyst
                </h3>
                <button class="modal__close" id="aiModalClose">&times;</button>
            </div>
            <div class="modal__body">
                <form id="aiForm" class="form-grid">
                    <div class="ai-intro"
                        style="margin-bottom: 20px; text-align: center; color: #a0a0b0; font-size: 0.9rem;">
                        <p>Upload comments (PDF, Excel, CSV) and Gemini AI will automatically analyze sentiment
                            percentages and generate remarks.</p>
                    </div>

                    <!-- Source Type Selection -->
                    <!-- Source Type Selection (Segmented Control) -->
                    <div class="form-row">
                        <label>Analysis Type</label>
                        <div class="segmented-control" id="aiSourceTypeContainer">
                            <button type="button" class="segment-btn active" data-value="candidate">Candidate</button>
                            <button type="button" class="segment-btn" data-value="news">News Media</button>
                            <button type="button" class="segment-btn" data-value="party">Political Party</button>
                        </div>
                        <!-- Hidden input to maintain compatibility with existing JS logic -->
                        <input type="hidden" id="aiSourceType" value="candidate">
                    </div>

                    <hr style="border-color: var(--border-glass);">

                    <!-- Candidate Section -->
                    <div id="aiCandidateSection">
                        <div class="form-row">
                            <label for="aiProvince">Province *</label>
                            <select id="aiProvince">
                                <option value="">Select Province</option>
                            </select>
                        </div>

                        <div class="form-grid form-grid--2col">
                            <div class="form-row">
                                <label for="aiDistrict">District *</label>
                                <select id="aiDistrict" disabled>
                                    <option value="">Select District</option>
                                </select>
                            </div>
                            <div class="form-row">
                                <label for="aiConstituency">Constituency *</label>
                                <select id="aiConstituency" disabled>
                                    <option value="">Select Constituency</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <label for="aiCandidateSelect">Select Candidate *</label>
                            <select id="aiCandidateSelect" disabled>
                                <option value="">-- Select a Candidate --</option>
                            </select>
                        </div>
                    </div>

                    <!-- News Media Section -->
                    <div id="aiNewsSection" style="display: none;">
                        <div class="form-row">
                            <label for="aiNewsSelect">News Source *</label>
                            <select id="aiNewsSelect">
                                <option value="">-- Select News Source --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Political Party Section -->
                    <div id="aiPartySection" style="display: none;">
                        <div class="form-row">
                            <label for="aiPartySelect">Political Party *</label>
                            <select id="aiPartySelect">
                                <option value="">-- Select Political Party --</option>
                            </select>
                        </div>
                    </div>

                    <!-- Source Post URL -->
                    <div class="form-row">
                        <label for="aiSourceUrl">Source Post URL (Optional)</label>
                        <input type="url" id="aiSourceUrl" placeholder="https://facebook.com/post/...">
                        <small class="text-muted">Link to the original post where comments were extracted from</small>
                    </div>

                    <!-- File Upload -->
                    <div class="form-row" style="margin-top: 20px;">
                        <label>Upload Comments Files (PDF, Excel, CSV)</label>
                        <div class="file-upload-zone" id="fileUploadZone"
                            style="border: 2px dashed rgba(255,255,255,0.2); padding: 30px; border-radius: 12px; text-align: center; cursor: pointer; transition: all 0.3s ease;">
                            <input type="file" id="aiFile" accept=".pdf,.csv,.xlsx,.xls" multiple
                                style="display: none;">
                            <i data-lucide="upload-cloud"
                                style="width: 48px; height: 48px; color: #8b5cf6; margin-bottom: 10px;"></i>
                            <p id="fileName" style="margin-bottom: 5px;">Click to browse or drag up to 10 files here</p>
                            <p class="text-muted" style="font-size: 0.8rem;">Max size: 20MB</p>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div id="aiLoading" style="display: none; text-align: center; margin-top: 20px;">
                        <div class="spinner" style="margin: 0 auto 15px;"></div>
                        <p style="color: #8b5cf6; font-weight: 500;">AI is analyzing comments...</p>
                        <p class="text-muted" style="font-size: 0.8rem;">This may take a few seconds</p>
                    </div>

                </form>
            </div>
            <div class="modal__footer">
                <button type="button" class="btn btn--secondary" id="aiModalCancel">Cancel</button>
                <button type="submit" form="aiForm" class="btn btn--primary" id="aiSubmitBtn"
                    style="background: linear-gradient(135deg, #6366f1, #8b5cf6); border: none;">
                    <i data-lucide="sparkles" style="width: 16px; height: 16px; margin-right: 8px;"></i>
                    Run Analysis
                </button>
            </div>
        </div>
    </div>

    <!-- Post Preview Modal -->
    <div class="modal-overlay post-preview-modal" id="postPreviewModal">
        <div class="modal modal--large">
            <div class="modal__header">
                <h3 class="modal__title" id="postPreviewTitle">
                    <i data-lucide="play-circle" style="width: 20px; height: 20px;"></i>
                    Post Preview
                </h3>
                <div class="modal__header-actions">
                    <a href="#" target="_blank" rel="noopener" class="btn btn--small btn--secondary" id="openInNewTab">
                        <i data-lucide="external-link" style="width: 14px; height: 14px;"></i>
                        Open in New Tab
                    </a>
                    <button class="modal__close" id="postPreviewModalClose">&times;</button>
                </div>
            </div>
            <div class="modal__body">
                <div class="post-preview-container" id="postPreviewContainer">
                    <div class="post-preview-loading" id="postPreviewLoading">
                        <div class="spinner"></div>
                        <p>Loading post...</p>
                    </div>
                    <iframe id="postPreviewIframe" class="post-preview-iframe" allowfullscreen></iframe>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <!-- PDF Export Container -->
    <div id="pdf-export-container"
        style="position: absolute; left: -9999px; top: 0; width: 595px; background: white; padding: 40px; box-sizing: border-box; font-family: 'Noto Sans Devanagari', sans-serif;">
    </div>

    <!-- Daily Reports Modal -->
    <div class="modal-overlay" id="dailyReportsModal">
        <div class="modal modal--large" style="max-width: 1200px; max-height: 90vh;">
            <div class="modal__header">
                <h3 class="modal__title">
                    <i data-lucide="bar-chart-2" style="width: 20px; height: 20px; color: #10B981;"></i>
                    Daily Political Analysis Report
                </h3>
                <button class="modal__close" id="dailyReportsModalClose">&times;</button>
            </div>
            <div class="modal__body" style="overflow-y: auto; max-height: calc(90vh - 120px);">
                <!-- Report Controls -->
                <div
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; gap: 12px; align-items: center;">
                        <input type="date" id="reportDatePicker"
                            style="padding: 10px 16px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: #f0f0f0;">
                        <button class="btn btn--primary" id="generateReportBtn"
                            style="background: linear-gradient(135deg, #10B981, #059669);">
                            <i data-lucide="zap" style="width: 16px; height: 16px;"></i>
                            Generate Report
                        </button>
                        <button class="btn btn--secondary" id="downloadReportBtn"
                            style="display: none; align-items: center; gap: 8px;">
                            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                            Download PDF
                        </button>
                    </div>
                    <span id="reportStatus" style="color: #999; font-size: 0.9rem;"></span>
                </div>

                <!-- Report Loading -->
                <div id="reportLoading" style="display: none; text-align: center; padding: 60px;">
                    <div class="spinner" style="margin: 0 auto 16px;"></div>
                    <p style="color: #999;">Generating report with AI analysis...</p>
                </div>

                <!-- Report No Data -->
                <div id="reportNoData" style="display: none; text-align: center; padding: 60px;">
                    <div style="margin-bottom: 16px;">
                        <i data-lucide="inbox"
                            style="width: 64px; height: 64px; opacity: 0.5; color: var(--text-muted);"></i>
                    </div>
                    <h3 style="color: #f0f0f0; margin: 0 0 8px;">No Report Available</h3>
                    <p style="color: #999; margin: 0;">Click "Generate Report" to create a new daily report</p>
                </div>

                <!-- Report Content -->
                <div id="reportContent" style="display: none;">
                    <!-- Summary Cards -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 24px;">
                        <div
                            style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="margin-bottom: 8px;">
                                <i data-lucide="file-text" style="width: 24px; height: 24px;"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #f0f0f0;" id="rptTotalPosts">0</div>
                            <div style="font-size: 0.8rem; color: #999;">Posts</div>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="margin-bottom: 8px;">
                                <i data-lucide="message-circle" style="width: 24px; height: 24px;"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #f0f0f0;" id="rptTotalComments">0
                            </div>
                            <div style="font-size: 0.8rem; color: #999;">Comments</div>
                        </div>
                        <div
                            style="background: rgba(16,185,129,0.1); border: 1px solid rgba(16,185,129,0.3); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="margin-bottom: 8px;">
                                <i data-lucide="thumbs-up" style="width: 24px; height: 24px;"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #10B981;" id="rptPositive">0%</div>
                            <div style="font-size: 0.8rem; color: #10B981;">Positive</div>
                        </div>
                        <div
                            style="background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="margin-bottom: 8px;">
                                <i data-lucide="thumbs-down" style="width: 24px; height: 24px;"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #EF4444;" id="rptNegative">0%</div>
                            <div style="font-size: 0.8rem; color: #EF4444;">Negative</div>
                        </div>
                        <div
                            style="background: rgba(107,114,128,0.1); border: 1px solid rgba(107,114,128,0.3); border-radius: 12px; padding: 16px; text-align: center;">
                            <div style="margin-bottom: 8px;">
                                <i data-lucide="meh" style="width: 24px; height: 24px;"></i>
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: #6B7280;" id="rptNeutral">0%</div>
                            <div style="font-size: 0.8rem; color: #6B7280;">Neutral</div>
                        </div>
                    </div>

                    <!-- Charts Section -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 24px;">
                        <div
                            style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px;">
                            <h4 style="color: #f0f0f0; margin: 0 0 16px; font-size: 1rem;">Overall Sentiment</h4>
                            <canvas id="rptPieChart" style="max-height: 250px;"></canvas>
                        </div>
                        <div
                            style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px;">
                            <h4 style="color: #f0f0f0; margin: 0 0 16px; font-size: 1rem;">By Source</h4>
                            <canvas id="rptBarChart" style="max-height: 250px;"></canvas>
                        </div>
                    </div>

                    <!-- AI Summary -->
                    <div
                        style="background: rgba(16,185,129,0.05); border: 1px solid rgba(16,185,129,0.2); border-radius: 12px; padding: 20px; margin-bottom: 24px;">
                        <h4 style="color: #10B981; margin: 0 0 12px; font-size: 1rem;">
                            <i data-lucide="sparkles" style="width: 16px; height: 16px; display: inline;"></i>
                            AI Analysis Summary
                        </h4>
                        <div id="rptAISummary" style="color: #ccc; line-height: 1.7;"></div>
                    </div>

                    <!-- Source Table -->
                    <div
                        style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px;">
                        <h4 style="color: #f0f0f0; margin: 0 0 16px; font-size: 1rem;">Source Breakdown</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse; font-size: 0.9rem;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.1);">
                                        <th style="padding: 12px; text-align: left; color: #999;">Source</th>
                                        <th style="padding: 12px; text-align: center; color: #999;">Posts</th>
                                        <th style="padding: 12px; text-align: center; color: #10B981;">Positive</th>
                                        <th style="padding: 12px; text-align: center; color: #EF4444;">Negative</th>
                                        <th style="padding: 12px; text-align: center; color: #6B7280;">Neutral</th>
                                    </tr>
                                </thead>
                                <tbody id="rptSourceTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <!-- Chart.js for Reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Background Script -->
    <script src="background.js"></script>

    <!-- App Script -->
    <script src="app.js"></script>

    <!-- Initialize Lucide Icons -->
    <script>
        lucide.createIcons();
    </script>
</body>

</html>